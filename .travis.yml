language: swift
os: osx
osx_image: xcode11.4
compiler: gcc

_shared_script:
  script: &1
  - brew install ninja
  - cmake -GNinja ${MYTOOLCHAIN} -S ./deps/ziti-sdk-c -B ./deps/ziti-sdk-c/build-${MYSDK}-${MYARCH}
  - ninja -C ./deps/ziti-sdk-c/build-${MYSDK}-${MYARCH}
  - xcodebuild build -configuration Release -scheme ${MYSCHEME} -derivedDataPath ./DerivedData/CZiti -arch ${MYARCH} -sdk ${MYSDK}
  - MYLIBDIR="DerivedData/CZiti/Build/Products/${MYCFGSDK}"
  - aws s3 sync "${TRAVIS_BUILD_DIR}/${MYLIBDIR}" s3://ziti-sdk-swift/${MYLIBDIR} --delete
  - MYDSDIR="DerivedData/CZiti/Build/Intermediates.noindex/CZiti.build/${MFCFGSDK}/${MYSCHEME}/DerivedSoures"
  - aws s3 sync "${TRAVIS_BILD_DIR}/${MYDSDIR}" s3://ziti-sdk-swift/${MYDSDIR} --delete

jobs:
  include:
  - stage: build
    env: MYSCHEME="CZiti-macOS" MYARCH="x86_64" MYSDK="macosx" MYTOOLCHAIN="" MYCFGSDK="Release"
    script: *1

  - stage: 
    env: MYSCHEME="CZiti-iOS" MYARCH="arm64" MYSDK="iphoneos" MYTOOLCHAIN="-DCMAKE_TOOLCHAIN_FILE=../toolchains/iOS-arm64.cmake" MYCFGSDK="Release-iphoneos"
    script: *1

  - stage: 
    env: MYSCHEME="CZiti-iOS" MYARCH="x86_64" MYSDK="iphonesimulator" MYTOOLCHAIN="-DCMAKE_TOOLCHAIN_FILE=../toolchains/iOS-x86_64.cmake"
      MYCFGSDK="Release-iphonesimulator"
    script: *1

  - stage: after_build
    script:
      - aws s3 sync s3://ziti-sdk-swift/DerivedData .
      - ls -lart

env:
  global:
  - secure: oJzBg0k0qiuaRV7p5V7ISt8FXl7aLFRZfGVaidOJqOB2rHYjXEZKjv8TcdrXJTfwtyH5mpwRtBD/hQpFvmaUdFJFKUe+aZyUoJDJq0KTr4rVJc+GQdqjp6qvwf8VDkXUBkFFc2zUBg5nkSUm6xTwunZ4Znpz75Dzh2AjP/R4WjBr00p4tKLxAQNKahix2TD38PbJyW5TGEOFmURzU7YzPDu1kOQm1nA9iQlHfjyFYAtc3JN6wTchLAUDUlIPVDKUcBuj1iDGUbAWfcJAMkcKO2mm6ERAvFSQMFUpP74TASpBnCxuax6J7AA+5L6O3oajGxqzJEA4WvM2lRp4sE9b0n8xCaA6oki1Fatr4+xAodbvuE4eIiJtpcYyEBt537K4+x7mKlhxXXIbzEbEygBRLOvE0tRAa5PwXHUpPyJOysG03Ah2Ap7RTnocbSGCH8S/3m9KuGes0Gf2/ZNJcdQEgYPollYqwlX4ddOgUgge6WL4KYS0Z7M/Aicz6kGEpTxEQKSOToyQN18Xo0kIFkoNtIPsgjT0R3oD9v6nHuypjezCWUcK0wBpae2HC0k9FIKPq2O2krNwI9yTX0Q6ckYK26EA2o7pNipbsdL7umc9iXi/tHRXf379nPkmU4f442TtUn2Ud9JQ5vLgsPRNqzHcr++xtYotiomnyCx4VSCl/H4=
  - secure: UfwdzhNwl0R7gSXvylgMw/lrQpHeBxWE1QJo3OErNt3zcwnNA3x/sTPtG+0+Fr2eVgIs6WoY12B4LR748nHHWjZgHPC34NvzInMqC1wz9NWzT5dHxGZp94xc2EltxhTPCJ+xbMGN4CbV/h1J5V7FnZRLTa/HFEcFefwaDAQO90mL8UoMEAlauHfXSU46fHfyPsqw252XF29c/eOjVCsMM1URDDcKx+PHITeu4TAOr4hYDoeIabVr9utFoZVYmd27Lwkshh5/JeTld1wRau4XjyDaGa7HJCEyhe/MfdE21jrBeq7Sjkz1wL6vg2mqc7OvujAlmxjlDD4U2/S+c+R3upnnuY7k5pgJm0qoKo+zJhzql0QK0p2qVzmO0rypt2Dckhha63gJE0dww2GzOinJmi6ySZKGigkQrHR6gk/Lukq2RL4+/9w/OfN7IlXwRwdxe49+dGbDbKZmw43SEQqzeksqth4TLpwLfGSOFdALlXlq+L8z1IStbnmMjVOUKylJFYFD+Qu54OPgbpyxzu+YhQL85huwI0EXkNkxyo6RHgSoZmCRqjn6Zcutd3KUJIuR5Fz304fNNmfGB/wJAzHKU3N3vixecWOOiE5ObqlDuJahFixJQS8h67w3imTqmI6dJzGxS5WZQmNDgVWjFWPXQ2xkrZGDwUNg7s559DfVytM=
